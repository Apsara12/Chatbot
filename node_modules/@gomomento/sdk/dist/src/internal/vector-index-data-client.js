"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VectorIndexDataClient = void 0;
const package_json_1 = require("../../package.json");
const sdk_core_1 = require("@gomomento/sdk-core");
const grpc_js_1 = require("@grpc/grpc-js");
const vectorindex_1 = require("@gomomento/generated-types/dist/vectorindex");
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const errors_1 = require("@gomomento/sdk-core/dist/src/errors");
const IVectorIndexClient_1 = require("@gomomento/sdk-core/dist/src/clients/IVectorIndexClient");
class VectorIndexDataClient {
    constructor(props) {
        this.configuration = props.configuration;
        this.credentialProvider = props.credentialProvider;
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(this.configuration.getThrowOnErrors());
        const grpcConfig = this.configuration
            .getTransportStrategy()
            .getGrpcConfig();
        this.requestTimeoutMs = grpcConfig.getDeadlineMillis();
        this.validateRequestTimeout(this.requestTimeoutMs);
        this.logger.debug(`Creating vector index client using endpoint: '${this.credentialProvider.getVectorEndpoint()}'`);
        this.client = new vectorindex_1.vectorindex.VectorIndexClient(this.credentialProvider.getVectorEndpoint(), grpc_js_1.ChannelCredentials.createSsl(), {
            // default value for max session memory is 10mb.  Under high load, it is easy to exceed this,
            // after which point all requests will fail with a client-side RESOURCE_EXHAUSTED exception.
            'grpc-node.max_session_memory': grpcConfig.getMaxSessionMemoryMb(),
            // This flag controls whether channels use a shared global pool of subchannels, or whether
            // each channel gets its own subchannel pool.  The default value is 0, meaning a single global
            // pool.  Setting it to 1 provides significant performance improvements when we instantiate more
            // than one grpc client.
            'grpc.use_local_subchannel_pool': 1,
            // The following settings are based on https://github.com/grpc/grpc/blob/e35db43c07f27cc13ec061520da1ed185f36abd4/doc/keepalive.md ,
            // and guidance provided on various github issues for grpc-node. They will enable keepalive pings when a
            // client connection is idle.
            'grpc.keepalive_permit_without_calls': 1,
            'grpc.keepalive_timeout_ms': 1000,
            'grpc.keepalive_time_ms': 5000,
        });
        this.interceptors = this.initializeInterceptors(this.configuration.getLoggerFactory());
    }
    async countItems(indexName) {
        try {
            (0, utils_1.validateIndexName)(indexName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorCountItems.Error(err));
        }
        return await this.sendCountItems(indexName);
    }
    async sendCountItems(indexName) {
        const request = new vectorindex_1.vectorindex._CountItemsRequest({
            index_name: indexName,
            all: new vectorindex_1.vectorindex._CountItemsRequest.All(),
        });
        return await new Promise((resolve, reject) => {
            this.client.CountItems(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorCountItems.Success(resp.item_count));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorCountItems.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async upsertItemBatch(indexName, items) {
        let request;
        try {
            (0, utils_1.validateIndexName)(indexName);
            // Create the request here to catch any metadata validation errors.
            request = VectorIndexDataClient.buildUpsertItemBatchRequest(indexName, items);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorUpsertItemBatch.Error(err));
        }
        return await this.sendUpsertItemBatch(indexName, request);
    }
    static buildUpsertItemBatchRequest(indexName, items) {
        return new vectorindex_1.vectorindex._UpsertItemBatchRequest({
            index_name: indexName,
            items: items.map(item => {
                return new vectorindex_1.vectorindex._Item({
                    id: item.id,
                    vector: new vectorindex_1.vectorindex._Vector({ elements: item.vector }),
                    metadata: VectorIndexDataClient.convertItemMetadataToProtobufMetadata(item),
                });
            }),
        });
    }
    static convertItemMetadataToProtobufMetadata(item) {
        if (item.metadata === undefined) {
            return [];
        }
        return Object.entries(item.metadata).map(([key, value]) => {
            if (typeof value === 'string') {
                return new vectorindex_1.vectorindex._Metadata({
                    field: key,
                    string_value: value,
                });
            }
            else if (typeof value === 'number') {
                if (Number.isInteger(value)) {
                    return new vectorindex_1.vectorindex._Metadata({
                        field: key,
                        integer_value: value,
                    });
                }
                else {
                    return new vectorindex_1.vectorindex._Metadata({
                        field: key,
                        double_value: value,
                    });
                }
            }
            else if (typeof value === 'boolean') {
                return new vectorindex_1.vectorindex._Metadata({
                    field: key,
                    boolean_value: value,
                });
            }
            else if (Array.isArray(value) &&
                value.every(item => typeof item === 'string')) {
                return new vectorindex_1.vectorindex._Metadata({
                    field: key,
                    list_of_strings_value: new vectorindex_1.vectorindex._Metadata._ListOfStrings({
                        values: value,
                    }),
                });
            }
            else {
                throw new sdk_core_1.InvalidArgumentError(`Metadata value for field '${key}' is not a valid type. Value is of type '${typeof value} and is not a string, number, boolean, or array of strings.'`);
            }
        });
    }
    async sendUpsertItemBatch(indexName, request) {
        return await new Promise((resolve, reject) => {
            this.client.UpsertItemBatch(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorUpsertItemBatch.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorUpsertItemBatch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async deleteItemBatch(indexName, ids) {
        try {
            (0, utils_1.validateIndexName)(indexName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorDeleteItemBatch.Error(err));
        }
        return await this.sendDeleteItemBatch(indexName, ids);
    }
    async sendDeleteItemBatch(indexName, ids) {
        const request = new vectorindex_1.vectorindex._DeleteItemBatchRequest({
            index_name: indexName,
            ids: ids,
        });
        return await new Promise((resolve, reject) => {
            this.client.DeleteItemBatch(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorDeleteItemBatch.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorDeleteItemBatch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async search(indexName, queryVector, options) {
        try {
            (0, utils_1.validateIndexName)(indexName);
            if ((options === null || options === void 0 ? void 0 : options.topK) !== undefined) {
                (0, utils_1.validateTopK)(options.topK);
            }
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorSearch.Error(err));
        }
        return await this.sendSearch(indexName, queryVector, options);
    }
    static prepareMetadataRequest(options) {
        const metadataRequest = new vectorindex_1.vectorindex._MetadataRequest();
        if ((options === null || options === void 0 ? void 0 : options.metadataFields) === IVectorIndexClient_1.ALL_VECTOR_METADATA) {
            metadataRequest.all = new vectorindex_1.vectorindex._MetadataRequest.All();
        }
        else {
            metadataRequest.some = new vectorindex_1.vectorindex._MetadataRequest.Some({
                fields: (options === null || options === void 0 ? void 0 : options.metadataFields) === undefined ? [] : options.metadataFields,
            });
        }
        return metadataRequest;
    }
    static applyScoreThreshold(request, options) {
        if ((options === null || options === void 0 ? void 0 : options.scoreThreshold) !== undefined) {
            request.score_threshold = options.scoreThreshold;
        }
        else {
            request.no_score_threshold = new vectorindex_1.vectorindex._NoScoreThreshold();
        }
    }
    static deserializeMetadata(metadata, errorCallback) {
        return metadata.reduce((acc, metadata) => {
            const field = metadata.field;
            switch (metadata.value) {
                case 'string_value':
                    acc[field] = metadata.string_value;
                    break;
                case 'integer_value':
                    acc[field] = metadata.integer_value;
                    break;
                case 'double_value':
                    acc[field] = metadata.double_value;
                    break;
                case 'boolean_value':
                    acc[field] = metadata.boolean_value;
                    break;
                case 'list_of_strings_value':
                    acc[field] = metadata.list_of_strings_value.values;
                    break;
                default:
                    errorCallback();
                    break;
            }
            return acc;
        }, {});
    }
    async sendSearch(indexName, queryVector, options) {
        const request = new vectorindex_1.vectorindex._SearchRequest({
            index_name: indexName,
            query_vector: new vectorindex_1.vectorindex._Vector({ elements: queryVector }),
            top_k: options === null || options === void 0 ? void 0 : options.topK,
            metadata_fields: VectorIndexDataClient.prepareMetadataRequest(options),
        });
        VectorIndexDataClient.applyScoreThreshold(request, options);
        return await new Promise((resolve, reject) => {
            this.client.Search(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorSearch.Success(resp.hits.map(hit => ({
                        id: hit.id,
                        score: hit.score,
                        metadata: VectorIndexDataClient.deserializeMetadata(hit.metadata, () => resolve(new sdk_core_1.VectorSearch.Error(new errors_1.UnknownError('Search responded with an unknown result')))),
                    }))));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorSearch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async searchAndFetchVectors(indexName, queryVector, options) {
        try {
            (0, utils_1.validateIndexName)(indexName);
            if ((options === null || options === void 0 ? void 0 : options.topK) !== undefined) {
                (0, utils_1.validateTopK)(options.topK);
            }
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorSearchAndFetchVectors.Error(err));
        }
        return await this.sendSearchAndFetchVectors(indexName, queryVector, options);
    }
    async sendSearchAndFetchVectors(indexName, queryVector, options) {
        const request = new vectorindex_1.vectorindex._SearchAndFetchVectorsRequest({
            index_name: indexName,
            query_vector: new vectorindex_1.vectorindex._Vector({ elements: queryVector }),
            top_k: options === null || options === void 0 ? void 0 : options.topK,
            metadata_fields: VectorIndexDataClient.prepareMetadataRequest(options),
        });
        VectorIndexDataClient.applyScoreThreshold(request, options);
        return await new Promise((resolve, reject) => {
            this.client.SearchAndFetchVectors(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorSearchAndFetchVectors.Success(resp.hits.map(hit => ({
                        id: hit.id,
                        score: hit.score,
                        vector: hit.vector.elements,
                        metadata: VectorIndexDataClient.deserializeMetadata(hit.metadata, () => resolve(new sdk_core_1.VectorSearchAndFetchVectors.Error(new errors_1.UnknownError('SearchAndFetchVectors responded with an unknown result')))),
                    }))));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorSearchAndFetchVectors.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async getItemBatch(indexName, ids) {
        try {
            (0, utils_1.validateIndexName)(indexName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorGetItemBatch.Error(err));
        }
        return await this.sendGetItemBatch(indexName, ids);
    }
    async sendGetItemBatch(indexName, ids) {
        const request = new vectorindex_1.vectorindex._GetItemBatchRequest({
            index_name: indexName,
            ids: ids,
            metadata_fields: VectorIndexDataClient.prepareMetadataRequest({
                metadataFields: IVectorIndexClient_1.ALL_VECTOR_METADATA,
            }),
        });
        return await new Promise((resolve, reject) => {
            this.client.GetItemBatch(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorGetItemBatch.Success(resp.item_response.reduce((acc, itemResponse) => {
                        switch (itemResponse.response) {
                            case 'hit':
                                acc[itemResponse.hit.id] = {
                                    id: itemResponse.hit.id,
                                    vector: itemResponse.hit.vector.elements,
                                    metadata: VectorIndexDataClient.deserializeMetadata(itemResponse.hit.metadata, () => resolve(new sdk_core_1.VectorGetItemBatch.Error(new errors_1.UnknownError('GetItemBatch responded with an unknown result')))),
                                };
                                break;
                            case 'miss':
                                break;
                            default:
                                resolve(new sdk_core_1.VectorGetItemBatch.Error(new errors_1.UnknownError('GetItemBatch responded with an unknown result')));
                                break;
                        }
                        return acc;
                    }, {})));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorGetItemBatch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async getItemMetadataBatch(indexName, ids) {
        try {
            (0, utils_1.validateIndexName)(indexName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.VectorGetItemMetadataBatch.Error(err));
        }
        return await this.sendGetItemMetadataBatch(indexName, ids);
    }
    async sendGetItemMetadataBatch(indexName, ids) {
        const request = new vectorindex_1.vectorindex._GetItemMetadataBatchRequest({
            index_name: indexName,
            ids: ids,
            metadata_fields: VectorIndexDataClient.prepareMetadataRequest({
                metadataFields: IVectorIndexClient_1.ALL_VECTOR_METADATA,
            }),
        });
        return await new Promise((resolve, reject) => {
            this.client.GetItemMetadataBatch(request, { interceptors: this.interceptors }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.VectorGetItemMetadataBatch.Success(resp.item_metadata_response.reduce((acc, itemResponse) => {
                        switch (itemResponse.response) {
                            case 'hit':
                                acc[itemResponse.hit.id] =
                                    VectorIndexDataClient.deserializeMetadata(itemResponse.hit.metadata, () => resolve(new sdk_core_1.VectorGetItemMetadataBatch.Error(new errors_1.UnknownError('GetItemMetadataBatch responded with an unknown result'))));
                                break;
                            case 'miss':
                                break;
                            default:
                                resolve(new sdk_core_1.VectorGetItemMetadataBatch.Error(new errors_1.UnknownError('GetItemMetadataBatch responded with an unknown result')));
                                break;
                        }
                        return acc;
                    }, {})));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.VectorGetItemMetadataBatch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    validateRequestTimeout(timeout) {
        this.logger.debug(`Request timeout ms: ${String(timeout)}`);
        if (timeout !== undefined && timeout <= 0) {
            throw new sdk_core_1.InvalidArgumentError('request timeout must be greater than zero.');
        }
    }
    initializeInterceptors(_loggerFactory) {
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        return [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(this.requestTimeoutMs),
        ];
    }
}
exports.VectorIndexDataClient = VectorIndexDataClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVjdG9yLWluZGV4LWRhdGEtY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ludGVybmFsL3ZlY3Rvci1pbmRleC1kYXRhLWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxREFBMkM7QUFFM0Msa0RBZ0I2QjtBQUU3QiwyQ0FBOEQ7QUFDOUQsNkVBQXdFO0FBQ3hFLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UscUZBQTZFO0FBQzdFLHVFQUdxRDtBQUNyRCxnRUFBaUU7QUFDakUsZ0dBQTRGO0FBRzVGLE1BQWEscUJBQXFCO0lBU2hDLFlBQVksS0FBdUM7UUFDakQsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BFLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLG9EQUF1QixDQUN4RCxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQ3RDLENBQUM7UUFDRixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYTthQUNsQyxvQkFBb0IsRUFBRTthQUN0QixhQUFhLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDdkQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLGlEQUFpRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxDQUNoRyxDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJ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QUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDLHdCQUF3QixFQUFFO1lBQ2pFLElBQUEscURBQXdCLEVBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1NBQ2hELENBQUM7SUFDSixDQUFDO0NBQ0Y7QUF6bkJELHNEQXluQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3ZlcnNpb259IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQge0lWZWN0b3JJbmRleERhdGFDbGllbnR9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvY2xpZW50cy92ZWN0b3IvSVZlY3RvckluZGV4RGF0YUNsaWVudCc7XG5pbXBvcnQge1xuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIEludmFsaWRBcmd1bWVudEVycm9yLFxuICBNb21lbnRvTG9nZ2VyLFxuICBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgU2VhcmNoT3B0aW9ucyxcbiAgVmVjdG9yQ291bnRJdGVtcyxcbiAgVmVjdG9yRGVsZXRlSXRlbUJhdGNoLFxuICBWZWN0b3JTZWFyY2gsXG4gIFZlY3RvclNlYXJjaEFuZEZldGNoVmVjdG9ycyxcbiAgVmVjdG9ySW5kZXhNZXRhZGF0YSxcbiAgVmVjdG9ySW5kZXhJdGVtLFxuICBWZWN0b3JVcHNlcnRJdGVtQmF0Y2gsXG4gIFZlY3RvckluZGV4U3RvcmVkSXRlbSxcbiAgVmVjdG9yR2V0SXRlbUJhdGNoLFxuICBWZWN0b3JHZXRJdGVtTWV0YWRhdGFCYXRjaCxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZSc7XG5pbXBvcnQge1ZlY3RvckluZGV4Q29uZmlndXJhdGlvbn0gZnJvbSAnLi4vY29uZmlnL3ZlY3Rvci1pbmRleC1jb25maWd1cmF0aW9uJztcbmltcG9ydCB7Q2hhbm5lbENyZWRlbnRpYWxzLCBJbnRlcmNlcHRvcn0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge3ZlY3RvcmluZGV4fSBmcm9tICdAZ29tb21lbnRvL2dlbmVyYXRlZC10eXBlcy9kaXN0L3ZlY3RvcmluZGV4JztcbmltcG9ydCB7SGVhZGVyLCBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyfSBmcm9tICcuL2dycGMvaGVhZGVycy1pbnRlcmNlcHRvcic7XG5pbXBvcnQge0NsaWVudFRpbWVvdXRJbnRlcmNlcHRvcn0gZnJvbSAnLi9ncnBjL2NsaWVudC10aW1lb3V0LWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXJ9IGZyb20gJy4uL2Vycm9ycy9jYWNoZS1zZXJ2aWNlLWVycm9yLW1hcHBlcic7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUluZGV4TmFtZSxcbiAgdmFsaWRhdGVUb3BLLFxufSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7VW5rbm93bkVycm9yfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2Vycm9ycyc7XG5pbXBvcnQge0FMTF9WRUNUT1JfTUVUQURBVEF9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvY2xpZW50cy9JVmVjdG9ySW5kZXhDbGllbnQnO1xuaW1wb3J0IHtWZWN0b3JJbmRleENsaWVudFByb3BzV2l0aENvbmZpZ30gZnJvbSAnLi92ZWN0b3ItaW5kZXgtY2xpZW50LXByb3BzLXdpdGgtY29uZmlnJztcblxuZXhwb3J0IGNsYXNzIFZlY3RvckluZGV4RGF0YUNsaWVudCBpbXBsZW1lbnRzIElWZWN0b3JJbmRleERhdGFDbGllbnQge1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IFZlY3RvckluZGV4Q29uZmlndXJhdGlvbjtcbiAgcHJpdmF0ZSByZWFkb25seSBjcmVkZW50aWFsUHJvdmlkZXI6IENyZWRlbnRpYWxQcm92aWRlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXI6IENhY2hlU2VydmljZUVycm9yTWFwcGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3RUaW1lb3V0TXM6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnQ6IHZlY3RvcmluZGV4LlZlY3RvckluZGV4Q2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGludGVyY2VwdG9yczogSW50ZXJjZXB0b3JbXTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogVmVjdG9ySW5kZXhDbGllbnRQcm9wc1dpdGhDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb24gPSBwcm9wcy5jb25maWd1cmF0aW9uO1xuICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIHRoaXMubG9nZ2VyID0gdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIodGhpcyk7XG4gICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlciA9IG5ldyBDYWNoZVNlcnZpY2VFcnJvck1hcHBlcihcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5nZXRUaHJvd09uRXJyb3JzKClcbiAgICApO1xuICAgIGNvbnN0IGdycGNDb25maWcgPSB0aGlzLmNvbmZpZ3VyYXRpb25cbiAgICAgIC5nZXRUcmFuc3BvcnRTdHJhdGVneSgpXG4gICAgICAuZ2V0R3JwY0NvbmZpZygpO1xuXG4gICAgdGhpcy5yZXF1ZXN0VGltZW91dE1zID0gZ3JwY0NvbmZpZy5nZXREZWFkbGluZU1pbGxpcygpO1xuICAgIHRoaXMudmFsaWRhdGVSZXF1ZXN0VGltZW91dCh0aGlzLnJlcXVlc3RUaW1lb3V0TXMpO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIHZlY3RvciBpbmRleCBjbGllbnQgdXNpbmcgZW5kcG9pbnQ6ICcke3RoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldFZlY3RvckVuZHBvaW50KCl9J2BcbiAgICApO1xuXG4gICAgdGhpcy5jbGllbnQgPSBuZXcgdmVjdG9yaW5kZXguVmVjdG9ySW5kZXhDbGllbnQoXG4gICAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRWZWN0b3JFbmRwb2ludCgpLFxuICAgICAgQ2hhbm5lbENyZWRlbnRpYWxzLmNyZWF0ZVNzbCgpLFxuICAgICAge1xuICAgICAgICAvLyBkZWZhdWx0IHZhbHVlIGZvciBtYXggc2Vzc2lvbiBtZW1vcnkgaXMgMTBtYi4gIFVuZGVyIGhpZ2ggbG9hZCwgaXQgaXMgZWFzeSB0byBleGNlZWQgdGhpcyxcbiAgICAgICAgLy8gYWZ0ZXIgd2hpY2ggcG9pbnQgYWxsIHJlcXVlc3RzIHdpbGwgZmFpbCB3aXRoIGEgY2xpZW50LXNpZGUgUkVTT1VSQ0VfRVhIQVVTVEVEIGV4Y2VwdGlvbi5cbiAgICAgICAgJ2dycGMtbm9kZS5tYXhfc2Vzc2lvbl9tZW1vcnknOiBncnBjQ29uZmlnLmdldE1heFNlc3Npb25NZW1vcnlNYigpLFxuICAgICAgICAvLyBUaGlzIGZsYWcgY29udHJvbHMgd2hldGhlciBjaGFubmVscyB1c2UgYSBzaGFyZWQgZ2xvYmFsIHBvb2wgb2Ygc3ViY2hhbm5lbHMsIG9yIHdoZXRoZXJcbiAgICAgICAgLy8gZWFjaCBjaGFubmVsIGdldHMgaXRzIG93biBzdWJjaGFubmVsIHBvb2wuICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAwLCBtZWFuaW5nIGEgc2luZ2xlIGdsb2JhbFxuICAgICAgICAvLyBwb29sLiAgU2V0dGluZyBpdCB0byAxIHByb3ZpZGVzIHNpZ25pZmljYW50IHBlcmZvcm1hbmNlIGltcHJvdmVtZW50cyB3aGVuIHdlIGluc3RhbnRpYXRlIG1vcmVcbiAgICAgICAgLy8gdGhhbiBvbmUgZ3JwYyBjbGllbnQuXG4gICAgICAgICdncnBjLnVzZV9sb2NhbF9zdWJjaGFubmVsX3Bvb2wnOiAxLFxuICAgICAgICAvLyBUaGUgZm9sbG93aW5nIHNldHRpbmdzIGFyZSBiYXNlZCBvbiBodHRwczovL2dpdGh1Yi5jb20vZ3JwYy9ncnBjL2Jsb2IvZTM1ZGI0M2MwN2YyN2NjMTNlYzA2MTUyMGRhMWVkMTg1ZjM2YWJkNC9kb2Mva2VlcGFsaXZlLm1kICxcbiAgICAgICAgLy8gYW5kIGd1aWRhbmNlIHByb3ZpZGVkIG9uIHZhcmlvdXMgZ2l0aHViIGlzc3VlcyBmb3IgZ3JwYy1ub2RlLiBUaGV5IHdpbGwgZW5hYmxlIGtlZXBhbGl2ZSBwaW5ncyB3aGVuIGFcbiAgICAgICAgLy8gY2xpZW50IGNvbm5lY3Rpb24gaXMgaWRsZS5cbiAgICAgICAgJ2dycGMua2VlcGFsaXZlX3Blcm1pdF93aXRob3V0X2NhbGxzJzogMSxcbiAgICAgICAgJ2dycGMua2VlcGFsaXZlX3RpbWVvdXRfbXMnOiAxMDAwLFxuICAgICAgICAnZ3JwYy5rZWVwYWxpdmVfdGltZV9tcyc6IDUwMDAsXG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMuaW50ZXJjZXB0b3JzID0gdGhpcy5pbml0aWFsaXplSW50ZXJjZXB0b3JzKFxuICAgICAgdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY291bnRJdGVtcyhcbiAgICBpbmRleE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPFZlY3RvckNvdW50SXRlbXMuUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVJbmRleE5hbWUoaW5kZXhOYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IFZlY3RvckNvdW50SXRlbXMuRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZENvdW50SXRlbXMoaW5kZXhOYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZENvdW50SXRlbXMoXG4gICAgaW5kZXhOYW1lOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxWZWN0b3JDb3VudEl0ZW1zLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyB2ZWN0b3JpbmRleC5fQ291bnRJdGVtc1JlcXVlc3Qoe1xuICAgICAgaW5kZXhfbmFtZTogaW5kZXhOYW1lLFxuICAgICAgYWxsOiBuZXcgdmVjdG9yaW5kZXguX0NvdW50SXRlbXNSZXF1ZXN0LkFsbCgpLFxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5Db3VudEl0ZW1zKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9yc30sXG4gICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgVmVjdG9yQ291bnRJdGVtcy5TdWNjZXNzKHJlc3AuaXRlbV9jb3VudCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IFZlY3RvckNvdW50SXRlbXMuRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cHNlcnRJdGVtQmF0Y2goXG4gICAgaW5kZXhOYW1lOiBzdHJpbmcsXG4gICAgaXRlbXM6IEFycmF5PFZlY3RvckluZGV4SXRlbT5cbiAgKTogUHJvbWlzZTxWZWN0b3JVcHNlcnRJdGVtQmF0Y2guUmVzcG9uc2U+IHtcbiAgICBsZXQgcmVxdWVzdDogdmVjdG9yaW5kZXguX1Vwc2VydEl0ZW1CYXRjaFJlcXVlc3Q7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlSW5kZXhOYW1lKGluZGV4TmFtZSk7XG5cbiAgICAgIC8vIENyZWF0ZSB0aGUgcmVxdWVzdCBoZXJlIHRvIGNhdGNoIGFueSBtZXRhZGF0YSB2YWxpZGF0aW9uIGVycm9ycy5cbiAgICAgIHJlcXVlc3QgPSBWZWN0b3JJbmRleERhdGFDbGllbnQuYnVpbGRVcHNlcnRJdGVtQmF0Y2hSZXF1ZXN0KFxuICAgICAgICBpbmRleE5hbWUsXG4gICAgICAgIGl0ZW1zXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgIGVyciA9PiBuZXcgVmVjdG9yVXBzZXJ0SXRlbUJhdGNoLkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRVcHNlcnRJdGVtQmF0Y2goaW5kZXhOYW1lLCByZXF1ZXN0KTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGJ1aWxkVXBzZXJ0SXRlbUJhdGNoUmVxdWVzdChcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBpdGVtczogQXJyYXk8VmVjdG9ySW5kZXhJdGVtPlxuICApOiB2ZWN0b3JpbmRleC5fVXBzZXJ0SXRlbUJhdGNoUmVxdWVzdCB7XG4gICAgcmV0dXJuIG5ldyB2ZWN0b3JpbmRleC5fVXBzZXJ0SXRlbUJhdGNoUmVxdWVzdCh7XG4gICAgICBpbmRleF9uYW1lOiBpbmRleE5hbWUsXG4gICAgICBpdGVtczogaXRlbXMubWFwKGl0ZW0gPT4ge1xuICAgICAgICByZXR1cm4gbmV3IHZlY3RvcmluZGV4Ll9JdGVtKHtcbiAgICAgICAgICBpZDogaXRlbS5pZCxcbiAgICAgICAgICB2ZWN0b3I6IG5ldyB2ZWN0b3JpbmRleC5fVmVjdG9yKHtlbGVtZW50czogaXRlbS52ZWN0b3J9KSxcbiAgICAgICAgICBtZXRhZGF0YTpcbiAgICAgICAgICAgIFZlY3RvckluZGV4RGF0YUNsaWVudC5jb252ZXJ0SXRlbU1ldGFkYXRhVG9Qcm90b2J1Zk1ldGFkYXRhKGl0ZW0pLFxuICAgICAgICB9KTtcbiAgICAgIH0pLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY29udmVydEl0ZW1NZXRhZGF0YVRvUHJvdG9idWZNZXRhZGF0YShcbiAgICBpdGVtOiBWZWN0b3JJbmRleEl0ZW1cbiAgKTogdmVjdG9yaW5kZXguX01ldGFkYXRhW10ge1xuICAgIGlmIChpdGVtLm1ldGFkYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGl0ZW0ubWV0YWRhdGEpLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICByZXR1cm4gbmV3IHZlY3RvcmluZGV4Ll9NZXRhZGF0YSh7XG4gICAgICAgICAgZmllbGQ6IGtleSxcbiAgICAgICAgICBzdHJpbmdfdmFsdWU6IHZhbHVlLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykge1xuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkpIHtcbiAgICAgICAgICByZXR1cm4gbmV3IHZlY3RvcmluZGV4Ll9NZXRhZGF0YSh7XG4gICAgICAgICAgICBmaWVsZDoga2V5LFxuICAgICAgICAgICAgaW50ZWdlcl92YWx1ZTogdmFsdWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyB2ZWN0b3JpbmRleC5fTWV0YWRhdGEoe1xuICAgICAgICAgICAgZmllbGQ6IGtleSxcbiAgICAgICAgICAgIGRvdWJsZV92YWx1ZTogdmFsdWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgcmV0dXJuIG5ldyB2ZWN0b3JpbmRleC5fTWV0YWRhdGEoe1xuICAgICAgICAgIGZpZWxkOiBrZXksXG4gICAgICAgICAgYm9vbGVhbl92YWx1ZTogdmFsdWUsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiZcbiAgICAgICAgdmFsdWUuZXZlcnkoaXRlbSA9PiB0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIG5ldyB2ZWN0b3JpbmRleC5fTWV0YWRhdGEoe1xuICAgICAgICAgIGZpZWxkOiBrZXksXG4gICAgICAgICAgbGlzdF9vZl9zdHJpbmdzX3ZhbHVlOiBuZXcgdmVjdG9yaW5kZXguX01ldGFkYXRhLl9MaXN0T2ZTdHJpbmdzKHtcbiAgICAgICAgICAgIHZhbHVlczogdmFsdWUsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEVycm9yKFxuICAgICAgICAgIGBNZXRhZGF0YSB2YWx1ZSBmb3IgZmllbGQgJyR7a2V5fScgaXMgbm90IGEgdmFsaWQgdHlwZS4gVmFsdWUgaXMgb2YgdHlwZSAnJHt0eXBlb2YgdmFsdWV9IGFuZCBpcyBub3QgYSBzdHJpbmcsIG51bWJlciwgYm9vbGVhbiwgb3IgYXJyYXkgb2Ygc3RyaW5ncy4nYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kVXBzZXJ0SXRlbUJhdGNoKFxuICAgIGluZGV4TmFtZTogc3RyaW5nLFxuICAgIHJlcXVlc3Q6IHZlY3RvcmluZGV4Ll9VcHNlcnRJdGVtQmF0Y2hSZXF1ZXN0XG4gICk6IFByb21pc2U8VmVjdG9yVXBzZXJ0SXRlbUJhdGNoLlJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LlVwc2VydEl0ZW1CYXRjaChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFZlY3RvclVwc2VydEl0ZW1CYXRjaC5TdWNjZXNzKCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IFZlY3RvclVwc2VydEl0ZW1CYXRjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZUl0ZW1CYXRjaChcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBpZHM6IEFycmF5PHN0cmluZz5cbiAgKTogUHJvbWlzZTxWZWN0b3JEZWxldGVJdGVtQmF0Y2guUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVJbmRleE5hbWUoaW5kZXhOYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IFZlY3RvckRlbGV0ZUl0ZW1CYXRjaC5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kRGVsZXRlSXRlbUJhdGNoKGluZGV4TmFtZSwgaWRzKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZERlbGV0ZUl0ZW1CYXRjaChcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBpZHM6IEFycmF5PHN0cmluZz5cbiAgKTogUHJvbWlzZTxWZWN0b3JEZWxldGVJdGVtQmF0Y2guUmVzcG9uc2U+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IHZlY3RvcmluZGV4Ll9EZWxldGVJdGVtQmF0Y2hSZXF1ZXN0KHtcbiAgICAgIGluZGV4X25hbWU6IGluZGV4TmFtZSxcbiAgICAgIGlkczogaWRzLFxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5EZWxldGVJdGVtQmF0Y2goXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBWZWN0b3JEZWxldGVJdGVtQmF0Y2guU3VjY2VzcygpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXNvbHZlT3JSZWplY3RFcnJvcih7XG4gICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICBlcnJvclJlc3BvbnNlRmFjdG9yeUZuOiBlID0+IG5ldyBWZWN0b3JEZWxldGVJdGVtQmF0Y2guRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZWFyY2goXG4gICAgaW5kZXhOYW1lOiBzdHJpbmcsXG4gICAgcXVlcnlWZWN0b3I6IEFycmF5PG51bWJlcj4sXG4gICAgb3B0aW9ucz86IFNlYXJjaE9wdGlvbnNcbiAgKTogUHJvbWlzZTxWZWN0b3JTZWFyY2guUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVJbmRleE5hbWUoaW5kZXhOYW1lKTtcbiAgICAgIGlmIChvcHRpb25zPy50b3BLICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdmFsaWRhdGVUb3BLKG9wdGlvbnMudG9wSyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBWZWN0b3JTZWFyY2guRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFNlYXJjaChpbmRleE5hbWUsIHF1ZXJ5VmVjdG9yLCBvcHRpb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIHByZXBhcmVNZXRhZGF0YVJlcXVlc3QoXG4gICAgb3B0aW9ucz86IFNlYXJjaE9wdGlvbnNcbiAgKTogdmVjdG9yaW5kZXguX01ldGFkYXRhUmVxdWVzdCB7XG4gICAgY29uc3QgbWV0YWRhdGFSZXF1ZXN0ID0gbmV3IHZlY3RvcmluZGV4Ll9NZXRhZGF0YVJlcXVlc3QoKTtcbiAgICBpZiAob3B0aW9ucz8ubWV0YWRhdGFGaWVsZHMgPT09IEFMTF9WRUNUT1JfTUVUQURBVEEpIHtcbiAgICAgIG1ldGFkYXRhUmVxdWVzdC5hbGwgPSBuZXcgdmVjdG9yaW5kZXguX01ldGFkYXRhUmVxdWVzdC5BbGwoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbWV0YWRhdGFSZXF1ZXN0LnNvbWUgPSBuZXcgdmVjdG9yaW5kZXguX01ldGFkYXRhUmVxdWVzdC5Tb21lKHtcbiAgICAgICAgZmllbGRzOlxuICAgICAgICAgIG9wdGlvbnM/Lm1ldGFkYXRhRmllbGRzID09PSB1bmRlZmluZWQgPyBbXSA6IG9wdGlvbnMubWV0YWRhdGFGaWVsZHMsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG1ldGFkYXRhUmVxdWVzdDtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGFwcGx5U2NvcmVUaHJlc2hvbGQoXG4gICAgcmVxdWVzdDpcbiAgICAgIHwgdmVjdG9yaW5kZXguX1NlYXJjaFJlcXVlc3RcbiAgICAgIHwgdmVjdG9yaW5kZXguX1NlYXJjaEFuZEZldGNoVmVjdG9yc1JlcXVlc3QsXG4gICAgb3B0aW9ucz86IFNlYXJjaE9wdGlvbnNcbiAgKTogdm9pZCB7XG4gICAgaWYgKG9wdGlvbnM/LnNjb3JlVGhyZXNob2xkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlcXVlc3Quc2NvcmVfdGhyZXNob2xkID0gb3B0aW9ucy5zY29yZVRocmVzaG9sZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVxdWVzdC5ub19zY29yZV90aHJlc2hvbGQgPSBuZXcgdmVjdG9yaW5kZXguX05vU2NvcmVUaHJlc2hvbGQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBkZXNlcmlhbGl6ZU1ldGFkYXRhKFxuICAgIG1ldGFkYXRhOiB2ZWN0b3JpbmRleC5fTWV0YWRhdGFbXSxcbiAgICBlcnJvckNhbGxiYWNrOiAoKSA9PiB2b2lkXG4gICk6IFZlY3RvckluZGV4TWV0YWRhdGEge1xuICAgIHJldHVybiBtZXRhZGF0YS5yZWR1Y2UoKGFjYywgbWV0YWRhdGEpID0+IHtcbiAgICAgIGNvbnN0IGZpZWxkID0gbWV0YWRhdGEuZmllbGQ7XG4gICAgICBzd2l0Y2ggKG1ldGFkYXRhLnZhbHVlKSB7XG4gICAgICAgIGNhc2UgJ3N0cmluZ192YWx1ZSc6XG4gICAgICAgICAgYWNjW2ZpZWxkXSA9IG1ldGFkYXRhLnN0cmluZ192YWx1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnaW50ZWdlcl92YWx1ZSc6XG4gICAgICAgICAgYWNjW2ZpZWxkXSA9IG1ldGFkYXRhLmludGVnZXJfdmFsdWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2RvdWJsZV92YWx1ZSc6XG4gICAgICAgICAgYWNjW2ZpZWxkXSA9IG1ldGFkYXRhLmRvdWJsZV92YWx1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnYm9vbGVhbl92YWx1ZSc6XG4gICAgICAgICAgYWNjW2ZpZWxkXSA9IG1ldGFkYXRhLmJvb2xlYW5fdmFsdWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2xpc3Rfb2Zfc3RyaW5nc192YWx1ZSc6XG4gICAgICAgICAgYWNjW2ZpZWxkXSA9IG1ldGFkYXRhLmxpc3Rfb2Zfc3RyaW5nc192YWx1ZS52YWx1ZXM7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgZXJyb3JDYWxsYmFjaygpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSBhcyBWZWN0b3JJbmRleE1ldGFkYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFNlYXJjaChcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBxdWVyeVZlY3RvcjogQXJyYXk8bnVtYmVyPixcbiAgICBvcHRpb25zPzogU2VhcmNoT3B0aW9uc1xuICApOiBQcm9taXNlPFZlY3RvclNlYXJjaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgdmVjdG9yaW5kZXguX1NlYXJjaFJlcXVlc3Qoe1xuICAgICAgaW5kZXhfbmFtZTogaW5kZXhOYW1lLFxuICAgICAgcXVlcnlfdmVjdG9yOiBuZXcgdmVjdG9yaW5kZXguX1ZlY3Rvcih7ZWxlbWVudHM6IHF1ZXJ5VmVjdG9yfSksXG4gICAgICB0b3Bfazogb3B0aW9ucz8udG9wSyxcbiAgICAgIG1ldGFkYXRhX2ZpZWxkczogVmVjdG9ySW5kZXhEYXRhQ2xpZW50LnByZXBhcmVNZXRhZGF0YVJlcXVlc3Qob3B0aW9ucyksXG4gICAgfSk7XG4gICAgVmVjdG9ySW5kZXhEYXRhQ2xpZW50LmFwcGx5U2NvcmVUaHJlc2hvbGQocmVxdWVzdCwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5jbGllbnQuU2VhcmNoKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9yc30sXG4gICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShcbiAgICAgICAgICAgICAgbmV3IFZlY3RvclNlYXJjaC5TdWNjZXNzKFxuICAgICAgICAgICAgICAgIHJlc3AuaGl0cy5tYXAoaGl0ID0+ICh7XG4gICAgICAgICAgICAgICAgICBpZDogaGl0LmlkLFxuICAgICAgICAgICAgICAgICAgc2NvcmU6IGhpdC5zY29yZSxcbiAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiBWZWN0b3JJbmRleERhdGFDbGllbnQuZGVzZXJpYWxpemVNZXRhZGF0YShcbiAgICAgICAgICAgICAgICAgICAgaGl0Lm1ldGFkYXRhLFxuICAgICAgICAgICAgICAgICAgICAoKSA9PlxuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yU2VhcmNoLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgVW5rbm93bkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTZWFyY2ggcmVzcG9uZGVkIHdpdGggYW4gdW5rbm93biByZXN1bHQnXG4gICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IFZlY3RvclNlYXJjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNlYXJjaEFuZEZldGNoVmVjdG9ycyhcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBxdWVyeVZlY3RvcjogQXJyYXk8bnVtYmVyPixcbiAgICBvcHRpb25zPzogU2VhcmNoT3B0aW9uc1xuICApOiBQcm9taXNlPFZlY3RvclNlYXJjaEFuZEZldGNoVmVjdG9ycy5SZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUluZGV4TmFtZShpbmRleE5hbWUpO1xuICAgICAgaWYgKG9wdGlvbnM/LnRvcEsgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB2YWxpZGF0ZVRvcEsob3B0aW9ucy50b3BLKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IFZlY3RvclNlYXJjaEFuZEZldGNoVmVjdG9ycy5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kU2VhcmNoQW5kRmV0Y2hWZWN0b3JzKFxuICAgICAgaW5kZXhOYW1lLFxuICAgICAgcXVlcnlWZWN0b3IsXG4gICAgICBvcHRpb25zXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFNlYXJjaEFuZEZldGNoVmVjdG9ycyhcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBxdWVyeVZlY3RvcjogQXJyYXk8bnVtYmVyPixcbiAgICBvcHRpb25zPzogU2VhcmNoT3B0aW9uc1xuICApOiBQcm9taXNlPFZlY3RvclNlYXJjaEFuZEZldGNoVmVjdG9ycy5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgdmVjdG9yaW5kZXguX1NlYXJjaEFuZEZldGNoVmVjdG9yc1JlcXVlc3Qoe1xuICAgICAgaW5kZXhfbmFtZTogaW5kZXhOYW1lLFxuICAgICAgcXVlcnlfdmVjdG9yOiBuZXcgdmVjdG9yaW5kZXguX1ZlY3Rvcih7ZWxlbWVudHM6IHF1ZXJ5VmVjdG9yfSksXG4gICAgICB0b3Bfazogb3B0aW9ucz8udG9wSyxcbiAgICAgIG1ldGFkYXRhX2ZpZWxkczogVmVjdG9ySW5kZXhEYXRhQ2xpZW50LnByZXBhcmVNZXRhZGF0YVJlcXVlc3Qob3B0aW9ucyksXG4gICAgfSk7XG4gICAgVmVjdG9ySW5kZXhEYXRhQ2xpZW50LmFwcGx5U2NvcmVUaHJlc2hvbGQocmVxdWVzdCwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5jbGllbnQuU2VhcmNoQW5kRmV0Y2hWZWN0b3JzKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9yc30sXG4gICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShcbiAgICAgICAgICAgICAgbmV3IFZlY3RvclNlYXJjaEFuZEZldGNoVmVjdG9ycy5TdWNjZXNzKFxuICAgICAgICAgICAgICAgIHJlc3AuaGl0cy5tYXAoaGl0ID0+ICh7XG4gICAgICAgICAgICAgICAgICBpZDogaGl0LmlkLFxuICAgICAgICAgICAgICAgICAgc2NvcmU6IGhpdC5zY29yZSxcbiAgICAgICAgICAgICAgICAgIHZlY3RvcjogaGl0LnZlY3Rvci5lbGVtZW50cyxcbiAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiBWZWN0b3JJbmRleERhdGFDbGllbnQuZGVzZXJpYWxpemVNZXRhZGF0YShcbiAgICAgICAgICAgICAgICAgICAgaGl0Lm1ldGFkYXRhLFxuICAgICAgICAgICAgICAgICAgICAoKSA9PlxuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yU2VhcmNoQW5kRmV0Y2hWZWN0b3JzLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgVW5rbm93bkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTZWFyY2hBbmRGZXRjaFZlY3RvcnMgcmVzcG9uZGVkIHdpdGggYW4gdW5rbm93biByZXN1bHQnXG4gICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT5cbiAgICAgICAgICAgICAgICBuZXcgVmVjdG9yU2VhcmNoQW5kRmV0Y2hWZWN0b3JzLkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0SXRlbUJhdGNoKFxuICAgIGluZGV4TmFtZTogc3RyaW5nLFxuICAgIGlkczogc3RyaW5nW11cbiAgKTogUHJvbWlzZTxWZWN0b3JHZXRJdGVtQmF0Y2guUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVJbmRleE5hbWUoaW5kZXhOYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IFZlY3RvckdldEl0ZW1CYXRjaC5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kR2V0SXRlbUJhdGNoKGluZGV4TmFtZSwgaWRzKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZEdldEl0ZW1CYXRjaChcbiAgICBpbmRleE5hbWU6IHN0cmluZyxcbiAgICBpZHM6IHN0cmluZ1tdXG4gICk6IFByb21pc2U8VmVjdG9yR2V0SXRlbUJhdGNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyB2ZWN0b3JpbmRleC5fR2V0SXRlbUJhdGNoUmVxdWVzdCh7XG4gICAgICBpbmRleF9uYW1lOiBpbmRleE5hbWUsXG4gICAgICBpZHM6IGlkcyxcbiAgICAgIG1ldGFkYXRhX2ZpZWxkczogVmVjdG9ySW5kZXhEYXRhQ2xpZW50LnByZXBhcmVNZXRhZGF0YVJlcXVlc3Qoe1xuICAgICAgICBtZXRhZGF0YUZpZWxkczogQUxMX1ZFQ1RPUl9NRVRBREFUQSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5HZXRJdGVtQmF0Y2goXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICBuZXcgVmVjdG9yR2V0SXRlbUJhdGNoLlN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgcmVzcC5pdGVtX3Jlc3BvbnNlLnJlZHVjZSgoYWNjLCBpdGVtUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICAgIHN3aXRjaCAoaXRlbVJlc3BvbnNlLnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2hpdCc6XG4gICAgICAgICAgICAgICAgICAgICAgYWNjW2l0ZW1SZXNwb25zZS5oaXQuaWRdID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGl0ZW1SZXNwb25zZS5oaXQuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB2ZWN0b3I6IGl0ZW1SZXNwb25zZS5oaXQudmVjdG9yLmVsZW1lbnRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGE6IFZlY3RvckluZGV4RGF0YUNsaWVudC5kZXNlcmlhbGl6ZU1ldGFkYXRhKFxuICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtUmVzcG9uc2UuaGl0Lm1ldGFkYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yR2V0SXRlbUJhdGNoLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgVW5rbm93bkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdHZXRJdGVtQmF0Y2ggcmVzcG9uZGVkIHdpdGggYW4gdW5rbm93biByZXN1bHQnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ21pc3MnOlxuICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yR2V0SXRlbUJhdGNoLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgVW5rbm93bkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdHZXRJdGVtQmF0Y2ggcmVzcG9uZGVkIHdpdGggYW4gdW5rbm93biByZXN1bHQnXG4gICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICAgICAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBWZWN0b3JJbmRleFN0b3JlZEl0ZW0+KVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IFZlY3RvckdldEl0ZW1CYXRjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEl0ZW1NZXRhZGF0YUJhdGNoKFxuICAgIGluZGV4TmFtZTogc3RyaW5nLFxuICAgIGlkczogc3RyaW5nW11cbiAgKTogUHJvbWlzZTxWZWN0b3JHZXRJdGVtTWV0YWRhdGFCYXRjaC5SZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUluZGV4TmFtZShpbmRleE5hbWUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgIGVyciA9PiBuZXcgVmVjdG9yR2V0SXRlbU1ldGFkYXRhQmF0Y2guRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZEdldEl0ZW1NZXRhZGF0YUJhdGNoKGluZGV4TmFtZSwgaWRzKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZEdldEl0ZW1NZXRhZGF0YUJhdGNoKFxuICAgIGluZGV4TmFtZTogc3RyaW5nLFxuICAgIGlkczogc3RyaW5nW11cbiAgKTogUHJvbWlzZTxWZWN0b3JHZXRJdGVtTWV0YWRhdGFCYXRjaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgdmVjdG9yaW5kZXguX0dldEl0ZW1NZXRhZGF0YUJhdGNoUmVxdWVzdCh7XG4gICAgICBpbmRleF9uYW1lOiBpbmRleE5hbWUsXG4gICAgICBpZHM6IGlkcyxcbiAgICAgIG1ldGFkYXRhX2ZpZWxkczogVmVjdG9ySW5kZXhEYXRhQ2xpZW50LnByZXBhcmVNZXRhZGF0YVJlcXVlc3Qoe1xuICAgICAgICBtZXRhZGF0YUZpZWxkczogQUxMX1ZFQ1RPUl9NRVRBREFUQSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5HZXRJdGVtTWV0YWRhdGFCYXRjaChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgIG5ldyBWZWN0b3JHZXRJdGVtTWV0YWRhdGFCYXRjaC5TdWNjZXNzKFxuICAgICAgICAgICAgICAgIHJlc3AuaXRlbV9tZXRhZGF0YV9yZXNwb25zZS5yZWR1Y2UoKGFjYywgaXRlbVJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBzd2l0Y2ggKGl0ZW1SZXNwb25zZS5yZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdoaXQnOlxuICAgICAgICAgICAgICAgICAgICAgIGFjY1tpdGVtUmVzcG9uc2UuaGl0LmlkXSA9XG4gICAgICAgICAgICAgICAgICAgICAgICBWZWN0b3JJbmRleERhdGFDbGllbnQuZGVzZXJpYWxpemVNZXRhZGF0YShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVJlc3BvbnNlLmhpdC5tZXRhZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvckdldEl0ZW1NZXRhZGF0YUJhdGNoLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgVW5rbm93bkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdHZXRJdGVtTWV0YWRhdGFCYXRjaCByZXNwb25kZWQgd2l0aCBhbiB1bmtub3duIHJlc3VsdCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ21pc3MnOlxuICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yR2V0SXRlbU1ldGFkYXRhQmF0Y2guRXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBVbmtub3duRXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0dldEl0ZW1NZXRhZGF0YUJhdGNoIHJlc3BvbmRlZCB3aXRoIGFuIHVua25vd24gcmVzdWx0J1xuICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgICAgICAgICAgfSwge30gYXMgUmVjb3JkPHN0cmluZywgVmVjdG9ySW5kZXhNZXRhZGF0YT4pXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PlxuICAgICAgICAgICAgICAgIG5ldyBWZWN0b3JHZXRJdGVtTWV0YWRhdGFCYXRjaC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KHRpbWVvdXQ/OiBudW1iZXIpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgUmVxdWVzdCB0aW1lb3V0IG1zOiAke1N0cmluZyh0aW1lb3V0KX1gKTtcbiAgICBpZiAodGltZW91dCAhPT0gdW5kZWZpbmVkICYmIHRpbWVvdXQgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEVycm9yKFxuICAgICAgICAncmVxdWVzdCB0aW1lb3V0IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uJ1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRpYWxpemVJbnRlcmNlcHRvcnMoXG4gICAgX2xvZ2dlckZhY3Rvcnk6IE1vbWVudG9Mb2dnZXJGYWN0b3J5XG4gICk6IEludGVyY2VwdG9yW10ge1xuICAgIGNvbnN0IGhlYWRlcnMgPSBbXG4gICAgICBuZXcgSGVhZGVyKCdBdXRob3JpemF0aW9uJywgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0QXV0aFRva2VuKCkpLFxuICAgICAgbmV3IEhlYWRlcignQWdlbnQnLCBgbm9kZWpzOiR7dmVyc2lvbn1gKSxcbiAgICBdO1xuICAgIHJldHVybiBbXG4gICAgICBuZXcgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcihoZWFkZXJzKS5jcmVhdGVIZWFkZXJzSW50ZXJjZXB0b3IoKSxcbiAgICAgIENsaWVudFRpbWVvdXRJbnRlcmNlcHRvcih0aGlzLnJlcXVlc3RUaW1lb3V0TXMpLFxuICAgIF07XG4gIH1cbn1cbiJdfQ==