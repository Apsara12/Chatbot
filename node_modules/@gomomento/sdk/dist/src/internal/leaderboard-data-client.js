"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LeaderboardDataClient = void 0;
const sdk_core_1 = require("@gomomento/sdk-core");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const leaderboard_1 = require("@gomomento/generated-types/dist/leaderboard");
var _Element = leaderboard_1.leaderboard._Element;
const idle_grpc_client_wrapper_1 = require("./grpc/idle-grpc-client-wrapper");
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
class LeaderboardDataClient {
    constructor(props) {
        this.configuration = props.configuration;
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(props.configuration.getThrowOnErrors());
        this.credentialProvider = props.credentialProvider;
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        const grpcConfig = this.configuration
            .getTransportStrategy()
            .getGrpcConfig();
        this.requestTimeoutMs = grpcConfig.getDeadlineMillis();
        this.validateRequestTimeout(this.requestTimeoutMs);
        this.logger.debug(`Creating leaderboard client using endpoint: '${this.credentialProvider.getCacheEndpoint()}'`);
        const numDataClients = grpcConfig.getNumClients();
        // We round-robin the requests through all of our clients.  Since javascript
        // is single-threaded, we don't have to worry about thread safety on this
        // index variable.
        this.nextDataClientIndex = 0;
        this.clientWrappers = (0, utils_1.range)(numDataClients).map(() => new idle_grpc_client_wrapper_1.IdleGrpcClientWrapper({
            clientFactoryFn: () => new leaderboard_1.leaderboard.LeaderboardClient(this.credentialProvider.getCacheEndpoint(), grpc_js_1.ChannelCredentials.createSsl(), {
                // default value for max session memory is 10mb.  Under high load, it is easy to exceed this,
                // after which point all requests will fail with a client-side RESOURCE_EXHAUSTED exception.
                'grpc-node.max_session_memory': grpcConfig.getMaxSessionMemoryMb(),
                // This flag controls whether channels use a shared global pool of subchannels, or whether
                // each channel gets its own subchannel pool.  The default value is 0, meaning a single global
                // pool.  Setting it to 1 provides significant performance improvements when we instantiate more
                // than one grpc client.
                'grpc.use_local_subchannel_pool': 1,
                // The following settings are based on https://github.com/grpc/grpc/blob/e35db43c07f27cc13ec061520da1ed185f36abd4/doc/keepalive.md ,
                // and guidance provided on various github issues for grpc-node. They will enable keepalive pings when a
                // client connection is idle.
                'grpc.keepalive_permit_without_calls': 1,
                'grpc.keepalive_timeout_ms': 1000,
                'grpc.keepalive_time_ms': 5000,
            }),
            loggerFactory: this.configuration.getLoggerFactory(),
            maxIdleMillis: this.configuration
                .getTransportStrategy()
                .getMaxIdleMillis(),
        }));
        this.interceptors = this.initializeInterceptors(this.configuration.getLoggerFactory());
    }
    validateRequestTimeout(timeout) {
        this.logger.debug(`Request timeout ms: ${String(timeout)}`);
        if (timeout !== undefined && timeout <= 0) {
            throw new sdk_core_1.InvalidArgumentError('request timeout must be greater than zero.');
        }
    }
    initializeInterceptors(_loggerFactory) {
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        return [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(this.requestTimeoutMs),
        ];
    }
    createMetadata(cacheName) {
        const metadata = new grpc_js_1.Metadata();
        metadata.set('cache', cacheName);
        return metadata;
    }
    convertMapOrRecordToElementsList(elements) {
        const convertedElements = [];
        if (elements instanceof Map) {
            elements.forEach((score, id) => convertedElements.push(new _Element({ id: id, score: score })));
        }
        else {
            Object.entries(elements).forEach(element => convertedElements.push(new _Element({ id: Number(element[0]), score: element[1] })));
        }
        return convertedElements;
    }
    async upsert(cacheName, leaderboardName, elements) {
        const size = elements instanceof Map ? elements.size : Object.keys(elements).length;
        try {
            (0, utils_1.validateLeaderboardNumberOfElements)(size);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardUpsert.Error(err));
        }
        this.logger.trace(`Issuing 'upsert' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, number of elements: ${size}`);
        return await this.sendUpsert(cacheName, leaderboardName, elements);
    }
    async sendUpsert(cacheName, leaderboardName, elements) {
        const request = new leaderboard_1.leaderboard._UpsertElementsRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            elements: this.convertMapOrRecordToElementsList(elements),
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().UpsertElements(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.LeaderboardUpsert.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardUpsert.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async fetchByScore(cacheName, leaderboardName, minScore, maxScore, order, offset, count) {
        var _a;
        const offsetValue = offset === undefined ? 0 : offset;
        const countValue = count === undefined ? 8192 : count;
        const orderValue = order !== null && order !== void 0 ? order : sdk_core_1.LeaderboardOrder.Ascending;
        try {
            (0, utils_1.validateSortedSetScores)(minScore, maxScore);
            (0, utils_1.validateLeaderboardOffset)(offsetValue);
            (0, utils_1.validateLeaderboardCount)(countValue);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardFetch.Error(err));
        }
        this.logger.trace(`Issuing 'fetchByScore' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, order: ${orderValue.toString()}, minScore: ${minScore !== null && minScore !== void 0 ? minScore : 'null'}, maxScore: ${(_a = maxScore === null || maxScore === void 0 ? void 0 : maxScore.toString()) !== null && _a !== void 0 ? _a : 'null'}, offset: ${offsetValue.toString()}, count: ${countValue.toString()}`);
        return await this.sendFetchByScore(cacheName, leaderboardName, orderValue, offsetValue, countValue, minScore, maxScore);
    }
    async sendFetchByScore(cacheName, leaderboardName, order, offset, count, minScore, maxScore) {
        const protoBufOrder = order === sdk_core_1.LeaderboardOrder.Descending
            ? leaderboard_1.leaderboard._Order.DESCENDING
            : leaderboard_1.leaderboard._Order.ASCENDING;
        const protoBufScoreRange = new leaderboard_1.leaderboard._ScoreRange();
        if (minScore !== undefined) {
            protoBufScoreRange.min_inclusive = minScore;
        }
        else {
            protoBufScoreRange.unbounded_min = new leaderboard_1.leaderboard._Unbounded();
        }
        if (maxScore !== undefined) {
            protoBufScoreRange.max_exclusive = maxScore;
        }
        else {
            protoBufScoreRange.unbounded_max = new leaderboard_1.leaderboard._Unbounded();
        }
        const request = new leaderboard_1.leaderboard._GetByScoreRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            score_range: protoBufScoreRange,
            order: protoBufOrder,
            offset: offset,
            limit_elements: count,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetByScore(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const foundElements = resp
                        .elements;
                    resolve(new sdk_core_1.LeaderboardFetch.Success(foundElements));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardFetch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async fetchByRank(cacheName, leaderboardName, startRank, endRank, order) {
        const rankOrder = order !== null && order !== void 0 ? order : sdk_core_1.LeaderboardOrder.Ascending;
        try {
            (0, utils_1.validateLeaderboardRanks)(startRank, endRank);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardFetch.Error(err));
        }
        this.logger.trace(`Issuing 'fetchByRank' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, order: ${rankOrder.toString()}, startRank: ${startRank}, endRank: ${endRank}`);
        return await this.sendFetchByRank(cacheName, leaderboardName, startRank, endRank, rankOrder);
    }
    async sendFetchByRank(cacheName, leaderboardName, startRank, endRank, order) {
        const protoBufOrder = order === sdk_core_1.LeaderboardOrder.Descending
            ? leaderboard_1.leaderboard._Order.DESCENDING
            : leaderboard_1.leaderboard._Order.ASCENDING;
        const protoBufRankRange = new leaderboard_1.leaderboard._RankRange({
            start_inclusive: startRank,
            end_exclusive: endRank,
        });
        const request = new leaderboard_1.leaderboard._GetByRankRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            rank_range: protoBufRankRange,
            order: protoBufOrder,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetByRank(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const foundElements = resp
                        .elements;
                    resolve(new sdk_core_1.LeaderboardFetch.Success(foundElements));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardFetch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async getRank(cacheName, leaderboardName, ids, order) {
        const orderValue = order !== null && order !== void 0 ? order : sdk_core_1.LeaderboardOrder.Ascending;
        this.logger.trace(`Issuing 'getRank' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, order: ${orderValue.toString()}, number of ids: ${ids.length}`);
        return await this.sendGetRank(cacheName, leaderboardName, ids, orderValue);
    }
    async sendGetRank(cacheName, leaderboardName, ids, order) {
        const protoBufOrder = order === sdk_core_1.LeaderboardOrder.Descending
            ? leaderboard_1.leaderboard._Order.DESCENDING
            : leaderboard_1.leaderboard._Order.ASCENDING;
        const request = new leaderboard_1.leaderboard._GetRankRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            ids: ids,
            order: protoBufOrder,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetRank(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const foundElements = resp
                        .elements;
                    resolve(new sdk_core_1.LeaderboardFetch.Success(foundElements));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardFetch.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async length(cacheName, leaderboardName) {
        this.logger.trace(`Issuing 'length' request; cache: ${cacheName}, leaderboard: ${leaderboardName}`);
        return await this.sendLength(cacheName, leaderboardName);
    }
    async sendLength(cacheName, leaderboardName) {
        const request = new leaderboard_1.leaderboard._GetLeaderboardLengthRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().GetLeaderboardLength(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    const length = resp
                        .count;
                    resolve(new sdk_core_1.LeaderboardLength.Success(length));
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardLength.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async removeElements(cacheName, leaderboardName, ids) {
        try {
            (0, utils_1.validateLeaderboardNumberOfElements)(ids.length);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.LeaderboardRemoveElements.Error(err));
        }
        this.logger.trace(`Issuing 'removeElements' request; cache: ${cacheName}, leaderboard: ${leaderboardName}, number of elements: ${ids.length.toString()}`);
        return await this.sendRemoveElements(cacheName, leaderboardName, ids);
    }
    async sendRemoveElements(cacheName, leaderboardName, ids) {
        const request = new leaderboard_1.leaderboard._RemoveElementsRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
            ids: ids,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().RemoveElements(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.LeaderboardRemoveElements.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardRemoveElements.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async delete(cacheName, leaderboardName) {
        this.logger.trace(`Issuing 'delete' request; cache: ${cacheName}, leaderboard: ${leaderboardName}`);
        return await this.sendDelete(cacheName, leaderboardName);
    }
    async sendDelete(cacheName, leaderboardName) {
        const request = new leaderboard_1.leaderboard._DeleteLeaderboardRequest({
            cache_name: cacheName,
            leaderboard: leaderboardName,
        });
        const metadata = this.createMetadata(cacheName);
        return await new Promise((resolve, reject) => {
            this.getNextDataClient().DeleteLeaderboard(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.LeaderboardDelete.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.LeaderboardDelete.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    getNextDataClient() {
        const clientWrapper = this.clientWrappers[this.nextDataClientIndex];
        this.nextDataClientIndex =
            (this.nextDataClientIndex + 1) % this.clientWrappers.length;
        return clientWrapper.getClient();
    }
}
exports.LeaderboardDataClient = LeaderboardDataClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhZGVyYm9hcmQtZGF0YS1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvbGVhZGVyYm9hcmQtZGF0YS1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0RBVzZCO0FBQzdCLHVFQU9xRDtBQUVyRCw2RUFBd0U7QUFDeEUsSUFBTyxRQUFRLEdBQUcseUJBQVcsQ0FBQyxRQUFRLENBQUM7QUFDdkMsOEVBQXNFO0FBRXRFLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UscUZBQTZFO0FBQzdFLDJDQUt1QjtBQUN2QixxREFBMkM7QUFJM0MsTUFBYSxxQkFBcUI7SUFVaEMsWUFBWSxLQUF1QztRQUNqRCxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7UUFDekMsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksb0RBQXVCLENBQ3hELEtBQUssQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FDdkMsQ0FBQztRQUNGLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhO2FBQ2xDLG9CQUFvQixFQUFFO2FBQ3RCLGFBQWEsRUFBRSxDQUFDO1FBRW5CLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN2RCxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsZ0RBQWdELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQzlGLENBQUM7UUFF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QUFFLElBQWEsRUFBRSxFQUFFO2dCQUMxQyxJQUFJLElBQUksRUFBRTtvQkFDUixPQUFPLENBQUMsSUFBSSw0QkFBaUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2lCQUMxQztxQkFBTTtvQkFDTCxJQUFJLENBQUMsdUJBQXVCLENBQUMsb0JBQW9CLENBQUM7d0JBQ2hELEdBQUcsRUFBRSxHQUFHO3dCQUNSLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSw0QkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO3dCQUMzRCxTQUFTLEVBQUUsT0FBTzt3QkFDbEIsUUFBUSxFQUFFLE1BQU07cUJBQ2pCLENBQUMsQ0FBQztpQkFDSjtZQUNILENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRVMsaUJBQWlCO1FBQ3pCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLG1CQUFtQjtZQUN0QixDQUFDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQztRQUM5RCxPQUFPLGFBQWEsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0NBQ0Y7QUF6aUJELHNEQXlpQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIEludmFsaWRBcmd1bWVudEVycm9yLFxuICBMZWFkZXJib2FyZERlbGV0ZSxcbiAgTGVhZGVyYm9hcmRGZXRjaCxcbiAgTGVhZGVyYm9hcmRMZW5ndGgsXG4gIExlYWRlcmJvYXJkUmVtb3ZlRWxlbWVudHMsXG4gIExlYWRlcmJvYXJkVXBzZXJ0LFxuICBNb21lbnRvTG9nZ2VyLFxuICBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgTGVhZGVyYm9hcmRPcmRlcixcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZSc7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUxlYWRlcmJvYXJkTnVtYmVyT2ZFbGVtZW50cyxcbiAgdmFsaWRhdGVTb3J0ZWRTZXRTY29yZXMsXG4gIHZhbGlkYXRlTGVhZGVyYm9hcmRPZmZzZXQsXG4gIHZhbGlkYXRlTGVhZGVyYm9hcmRDb3VudCxcbiAgdmFsaWRhdGVMZWFkZXJib2FyZFJhbmtzLFxuICByYW5nZSxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQge0xlYWRlcmJvYXJkQ29uZmlndXJhdGlvbn0gZnJvbSAnLi4vY29uZmlnL2xlYWRlcmJvYXJkLWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHtsZWFkZXJib2FyZH0gZnJvbSAnQGdvbW9tZW50by9nZW5lcmF0ZWQtdHlwZXMvZGlzdC9sZWFkZXJib2FyZCc7XG5pbXBvcnQgX0VsZW1lbnQgPSBsZWFkZXJib2FyZC5fRWxlbWVudDtcbmltcG9ydCB7SWRsZUdycGNDbGllbnRXcmFwcGVyfSBmcm9tICcuL2dycGMvaWRsZS1ncnBjLWNsaWVudC13cmFwcGVyJztcbmltcG9ydCB7R3JwY0NsaWVudFdyYXBwZXJ9IGZyb20gJy4vZ3JwYy9ncnBjLWNsaWVudC13cmFwcGVyJztcbmltcG9ydCB7SGVhZGVyLCBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyfSBmcm9tICcuL2dycGMvaGVhZGVycy1pbnRlcmNlcHRvcic7XG5pbXBvcnQge0NsaWVudFRpbWVvdXRJbnRlcmNlcHRvcn0gZnJvbSAnLi9ncnBjL2NsaWVudC10aW1lb3V0LWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXJ9IGZyb20gJy4uL2Vycm9ycy9jYWNoZS1zZXJ2aWNlLWVycm9yLW1hcHBlcic7XG5pbXBvcnQge1xuICBDaGFubmVsQ3JlZGVudGlhbHMsXG4gIEludGVyY2VwdG9yLFxuICBNZXRhZGF0YSxcbiAgU2VydmljZUVycm9yLFxufSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7dmVyc2lvbn0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7SUxlYWRlcmJvYXJkRGF0YUNsaWVudH0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzL2xlYWRlcmJvYXJkL0lMZWFkZXJib2FyZERhdGFDbGllbnQnO1xuaW1wb3J0IHtMZWFkZXJib2FyZENsaWVudFByb3BzV2l0aENvbmZpZ30gZnJvbSAnLi9sZWFkZXJib2FyZC1jbGllbnQtcHJvcHMtd2l0aC1jb25maWcnO1xuXG5leHBvcnQgY2xhc3MgTGVhZGVyYm9hcmREYXRhQ2xpZW50IGltcGxlbWVudHMgSUxlYWRlcmJvYXJkRGF0YUNsaWVudCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29uZmlndXJhdGlvbjogTGVhZGVyYm9hcmRDb25maWd1cmF0aW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGNyZWRlbnRpYWxQcm92aWRlcjogQ3JlZGVudGlhbFByb3ZpZGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogTW9tZW50b0xvZ2dlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBjYWNoZVNlcnZpY2VFcnJvck1hcHBlcjogQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdFRpbWVvdXRNczogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudFdyYXBwZXJzOiBHcnBjQ2xpZW50V3JhcHBlcjxsZWFkZXJib2FyZC5MZWFkZXJib2FyZENsaWVudD5bXTtcbiAgcHJvdGVjdGVkIG5leHREYXRhQ2xpZW50SW5kZXg6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBpbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IExlYWRlcmJvYXJkQ2xpZW50UHJvcHNXaXRoQ29uZmlnKSB7XG4gICAgdGhpcy5jb25maWd1cmF0aW9uID0gcHJvcHMuY29uZmlndXJhdGlvbjtcbiAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyID0gbmV3IENhY2hlU2VydmljZUVycm9yTWFwcGVyKFxuICAgICAgcHJvcHMuY29uZmlndXJhdGlvbi5nZXRUaHJvd09uRXJyb3JzKClcbiAgICApO1xuICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIHRoaXMubG9nZ2VyID0gdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIodGhpcyk7XG4gICAgY29uc3QgZ3JwY0NvbmZpZyA9IHRoaXMuY29uZmlndXJhdGlvblxuICAgICAgLmdldFRyYW5zcG9ydFN0cmF0ZWd5KClcbiAgICAgIC5nZXRHcnBjQ29uZmlnKCk7XG5cbiAgICB0aGlzLnJlcXVlc3RUaW1lb3V0TXMgPSBncnBjQ29uZmlnLmdldERlYWRsaW5lTWlsbGlzKCk7XG4gICAgdGhpcy52YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KHRoaXMucmVxdWVzdFRpbWVvdXRNcyk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICBgQ3JlYXRpbmcgbGVhZGVyYm9hcmQgY2xpZW50IHVzaW5nIGVuZHBvaW50OiAnJHt0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRDYWNoZUVuZHBvaW50KCl9J2BcbiAgICApO1xuXG4gICAgY29uc3QgbnVtRGF0YUNsaWVudHMgPSBncnBjQ29uZmlnLmdldE51bUNsaWVudHMoKTtcblxuICAgIC8vIFdlIHJvdW5kLXJvYmluIHRoZSByZXF1ZXN0cyB0aHJvdWdoIGFsbCBvZiBvdXIgY2xpZW50cy4gIFNpbmNlIGphdmFzY3JpcHRcbiAgICAvLyBpcyBzaW5nbGUtdGhyZWFkZWQsIHdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgdGhyZWFkIHNhZmV0eSBvbiB0aGlzXG4gICAgLy8gaW5kZXggdmFyaWFibGUuXG4gICAgdGhpcy5uZXh0RGF0YUNsaWVudEluZGV4ID0gMDtcblxuICAgIHRoaXMuY2xpZW50V3JhcHBlcnMgPSByYW5nZShudW1EYXRhQ2xpZW50cykubWFwKFxuICAgICAgKCkgPT5cbiAgICAgICAgbmV3IElkbGVHcnBjQ2xpZW50V3JhcHBlcih7XG4gICAgICAgICAgY2xpZW50RmFjdG9yeUZuOiAoKSA9PlxuICAgICAgICAgICAgbmV3IGxlYWRlcmJvYXJkLkxlYWRlcmJvYXJkQ2xpZW50KFxuICAgICAgICAgICAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRDYWNoZUVuZHBvaW50KCksXG4gICAgICAgICAgICAgIENoYW5uZWxDcmVkZW50aWFscy5jcmVhdGVTc2woKSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgdmFsdWUgZm9yIG1heCBzZXNzaW9uIG1lbW9yeSBpcyAxMG1iLiAgVW5kZXIgaGlnaCBsb2FkLCBpdCBpcyBlYXN5IHRvIGV4Y2VlZCB0aGlzLFxuICAgICAgICAgICAgICAgIC8vIGFmdGVyIHdoaWNoIHBvaW50IGFsbCByZXF1ZXN0cyB3aWxsIGZhaWwgd2l0aCBhIGNsaWVudC1zaWRlIFJFU09VUkNFX0VYSEFVU1RFRCBleGNlcHRpb24uXG4gICAgICAgICAgICAgICAgJ2dycGMtbm9kZS5tYXhfc2Vzc2lvbl9tZW1vcnknOlxuICAgICAgICAgICAgICAgICAgZ3JwY0NvbmZpZy5nZXRNYXhTZXNzaW9uTWVtb3J5TWIoKSxcbiAgICAgICAgICAgICAgICAvLyBUaGlzIGZsYWcgY29udHJvbHMgd2hldGhlciBjaGFubmVscyB1c2UgYSBzaGFyZWQgZ2xvYmFsIHBvb2wgb2Ygc3ViY2hhbm5lbHMsIG9yIHdoZXRoZXJcbiAgICAgICAgICAgICAgICAvLyBlYWNoIGNoYW5uZWwgZ2V0cyBpdHMgb3duIHN1YmNoYW5uZWwgcG9vbC4gIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDAsIG1lYW5pbmcgYSBzaW5nbGUgZ2xvYmFsXG4gICAgICAgICAgICAgICAgLy8gcG9vbC4gIFNldHRpbmcgaXQgdG8gMSBwcm92aWRlcyBzaWduaWZpY2FudCBwZXJmb3JtYW5jZSBpbXByb3ZlbWVudHMgd2hlbiB3ZSBpbnN0YW50aWF0ZSBtb3JlXG4gICAgICAgICAgICAgICAgLy8gdGhhbiBvbmUgZ3JwYyBjbGllbnQuXG4gICAgICAgICAgICAgICAgJ2dycGMudXNlX2xvY2FsX3N1YmNoYW5uZWxfcG9vbCc6IDEsXG4gICAgICAgICAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBzZXR0aW5ncyBhcmUgYmFzZWQgb24gaHR0cHM6Ly9naXRodWIuY29tL2dycGMvZ3JwYy9ibG9iL2UzNWRiNDNjMDdmMjdjYzEzZWMwNjE1MjBkYTFlZDE4NWYzNmFiZDQvZG9jL2tlZXBhbGl2ZS5tZCAsXG4gICAgICAgICAgICAgICAgLy8gYW5kIGd1aWRhbmNlIHByb3ZpZGVkIG9uIHZhcmlvdXMgZ2l0aHViIGlzc3VlcyBmb3IgZ3JwYy1ub2RlLiBUaGV5IHdpbGwgZW5hYmxlIGtlZXBhbGl2ZSBwaW5ncyB3aGVuIGFcbiAgICAgICAgICAgICAgICAvLyBjbGllbnQgY29ubmVjdGlvbiBpcyBpZGxlLlxuICAgICAgICAgICAgICAgICdncnBjLmtlZXBhbGl2ZV9wZXJtaXRfd2l0aG91dF9jYWxscyc6IDEsXG4gICAgICAgICAgICAgICAgJ2dycGMua2VlcGFsaXZlX3RpbWVvdXRfbXMnOiAxMDAwLFxuICAgICAgICAgICAgICAgICdncnBjLmtlZXBhbGl2ZV90aW1lX21zJzogNTAwMCxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICBsb2dnZXJGYWN0b3J5OiB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLFxuICAgICAgICAgIG1heElkbGVNaWxsaXM6IHRoaXMuY29uZmlndXJhdGlvblxuICAgICAgICAgICAgLmdldFRyYW5zcG9ydFN0cmF0ZWd5KClcbiAgICAgICAgICAgIC5nZXRNYXhJZGxlTWlsbGlzKCksXG4gICAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuaW50ZXJjZXB0b3JzID0gdGhpcy5pbml0aWFsaXplSW50ZXJjZXB0b3JzKFxuICAgICAgdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUmVxdWVzdFRpbWVvdXQodGltZW91dD86IG51bWJlcikge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBSZXF1ZXN0IHRpbWVvdXQgbXM6ICR7U3RyaW5nKHRpbWVvdXQpfWApO1xuICAgIGlmICh0aW1lb3V0ICE9PSB1bmRlZmluZWQgJiYgdGltZW91dCA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50RXJyb3IoXG4gICAgICAgICdyZXF1ZXN0IHRpbWVvdXQgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4nXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUludGVyY2VwdG9ycyhcbiAgICBfbG9nZ2VyRmFjdG9yeTogTW9tZW50b0xvZ2dlckZhY3RvcnlcbiAgKTogSW50ZXJjZXB0b3JbXSB7XG4gICAgY29uc3QgaGVhZGVycyA9IFtcbiAgICAgIG5ldyBIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCB0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRBdXRoVG9rZW4oKSksXG4gICAgICBuZXcgSGVhZGVyKCdBZ2VudCcsIGBub2RlanM6JHt2ZXJzaW9ufWApLFxuICAgIF07XG4gICAgcmV0dXJuIFtcbiAgICAgIG5ldyBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyKGhlYWRlcnMpLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcigpLFxuICAgICAgQ2xpZW50VGltZW91dEludGVyY2VwdG9yKHRoaXMucmVxdWVzdFRpbWVvdXRNcyksXG4gICAgXTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWV0YWRhdGEoY2FjaGVOYW1lOiBzdHJpbmcpOiBNZXRhZGF0YSB7XG4gICAgY29uc3QgbWV0YWRhdGEgPSBuZXcgTWV0YWRhdGEoKTtcbiAgICBtZXRhZGF0YS5zZXQoJ2NhY2hlJywgY2FjaGVOYW1lKTtcbiAgICByZXR1cm4gbWV0YWRhdGE7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRNYXBPclJlY29yZFRvRWxlbWVudHNMaXN0KFxuICAgIGVsZW1lbnRzOiBSZWNvcmQ8bnVtYmVyLCBudW1iZXI+IHwgTWFwPG51bWJlciwgbnVtYmVyPlxuICApOiBfRWxlbWVudFtdIHtcbiAgICBjb25zdCBjb252ZXJ0ZWRFbGVtZW50czogX0VsZW1lbnRbXSA9IFtdO1xuICAgIGlmIChlbGVtZW50cyBpbnN0YW5jZW9mIE1hcCkge1xuICAgICAgZWxlbWVudHMuZm9yRWFjaCgoc2NvcmUsIGlkKSA9PlxuICAgICAgICBjb252ZXJ0ZWRFbGVtZW50cy5wdXNoKG5ldyBfRWxlbWVudCh7aWQ6IGlkLCBzY29yZTogc2NvcmV9KSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKGVsZW1lbnRzKS5mb3JFYWNoKGVsZW1lbnQgPT5cbiAgICAgICAgY29udmVydGVkRWxlbWVudHMucHVzaChcbiAgICAgICAgICBuZXcgX0VsZW1lbnQoe2lkOiBOdW1iZXIoZWxlbWVudFswXSksIHNjb3JlOiBlbGVtZW50WzFdfSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnZlcnRlZEVsZW1lbnRzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwc2VydChcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBlbGVtZW50czogUmVjb3JkPG51bWJlciwgbnVtYmVyPiB8IE1hcDxudW1iZXIsIG51bWJlcj5cbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZFVwc2VydC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHNpemUgPVxuICAgICAgZWxlbWVudHMgaW5zdGFuY2VvZiBNYXAgPyBlbGVtZW50cy5zaXplIDogT2JqZWN0LmtleXMoZWxlbWVudHMpLmxlbmd0aDtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVMZWFkZXJib2FyZE51bWJlck9mRWxlbWVudHMoc2l6ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBMZWFkZXJib2FyZFVwc2VydC5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICd1cHNlcnQnIHJlcXVlc3Q7IGNhY2hlOiAke2NhY2hlTmFtZX0sIGxlYWRlcmJvYXJkOiAke2xlYWRlcmJvYXJkTmFtZX0sIG51bWJlciBvZiBlbGVtZW50czogJHtzaXplfWBcbiAgICApO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRVcHNlcnQoY2FjaGVOYW1lLCBsZWFkZXJib2FyZE5hbWUsIGVsZW1lbnRzKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFVwc2VydChcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBlbGVtZW50czogUmVjb3JkPG51bWJlciwgbnVtYmVyPiB8IE1hcDxudW1iZXIsIG51bWJlcj5cbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZFVwc2VydC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgbGVhZGVyYm9hcmQuX1Vwc2VydEVsZW1lbnRzUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgICBsZWFkZXJib2FyZDogbGVhZGVyYm9hcmROYW1lLFxuICAgICAgZWxlbWVudHM6IHRoaXMuY29udmVydE1hcE9yUmVjb3JkVG9FbGVtZW50c0xpc3QoZWxlbWVudHMpLFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShjYWNoZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldE5leHREYXRhQ2xpZW50KCkuVXBzZXJ0RWxlbWVudHMoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVycjogU2VydmljZUVycm9yIHwgbnVsbCwgcmVzcDogdW5rbm93bikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMZWFkZXJib2FyZFVwc2VydC5TdWNjZXNzKCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IExlYWRlcmJvYXJkVXBzZXJ0LkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZmV0Y2hCeVNjb3JlKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIG1pblNjb3JlPzogbnVtYmVyLFxuICAgIG1heFNjb3JlPzogbnVtYmVyLFxuICAgIG9yZGVyPzogTGVhZGVyYm9hcmRPcmRlcixcbiAgICBvZmZzZXQ/OiBudW1iZXIsXG4gICAgY291bnQ/OiBudW1iZXJcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZEZldGNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBvZmZzZXQgPT09IHVuZGVmaW5lZCA/IDAgOiBvZmZzZXQ7XG4gICAgY29uc3QgY291bnRWYWx1ZSA9IGNvdW50ID09PSB1bmRlZmluZWQgPyA4MTkyIDogY291bnQ7XG4gICAgY29uc3Qgb3JkZXJWYWx1ZSA9IG9yZGVyID8/IExlYWRlcmJvYXJkT3JkZXIuQXNjZW5kaW5nO1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZVNvcnRlZFNldFNjb3JlcyhtaW5TY29yZSwgbWF4U2NvcmUpO1xuICAgICAgdmFsaWRhdGVMZWFkZXJib2FyZE9mZnNldChvZmZzZXRWYWx1ZSk7XG4gICAgICB2YWxpZGF0ZUxlYWRlcmJvYXJkQ291bnQoY291bnRWYWx1ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBMZWFkZXJib2FyZEZldGNoLkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ2ZldGNoQnlTY29yZScgcmVxdWVzdDsgY2FjaGU6ICR7Y2FjaGVOYW1lfSwgbGVhZGVyYm9hcmQ6ICR7bGVhZGVyYm9hcmROYW1lfSwgb3JkZXI6ICR7b3JkZXJWYWx1ZS50b1N0cmluZygpfSwgbWluU2NvcmU6ICR7XG4gICAgICAgIG1pblNjb3JlID8/ICdudWxsJ1xuICAgICAgfSwgbWF4U2NvcmU6ICR7XG4gICAgICAgIG1heFNjb3JlPy50b1N0cmluZygpID8/ICdudWxsJ1xuICAgICAgfSwgb2Zmc2V0OiAke29mZnNldFZhbHVlLnRvU3RyaW5nKCl9LCBjb3VudDogJHtjb3VudFZhbHVlLnRvU3RyaW5nKCl9YFxuICAgICk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZEZldGNoQnlTY29yZShcbiAgICAgIGNhY2hlTmFtZSxcbiAgICAgIGxlYWRlcmJvYXJkTmFtZSxcbiAgICAgIG9yZGVyVmFsdWUsXG4gICAgICBvZmZzZXRWYWx1ZSxcbiAgICAgIGNvdW50VmFsdWUsXG4gICAgICBtaW5TY29yZSxcbiAgICAgIG1heFNjb3JlXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZEZldGNoQnlTY29yZShcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBvcmRlcjogTGVhZGVyYm9hcmRPcmRlcixcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICBjb3VudDogbnVtYmVyLFxuICAgIG1pblNjb3JlPzogbnVtYmVyLFxuICAgIG1heFNjb3JlPzogbnVtYmVyXG4gICk6IFByb21pc2U8TGVhZGVyYm9hcmRGZXRjaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHByb3RvQnVmT3JkZXIgPVxuICAgICAgb3JkZXIgPT09IExlYWRlcmJvYXJkT3JkZXIuRGVzY2VuZGluZ1xuICAgICAgICA/IGxlYWRlcmJvYXJkLl9PcmRlci5ERVNDRU5ESU5HXG4gICAgICAgIDogbGVhZGVyYm9hcmQuX09yZGVyLkFTQ0VORElORztcblxuICAgIGNvbnN0IHByb3RvQnVmU2NvcmVSYW5nZSA9IG5ldyBsZWFkZXJib2FyZC5fU2NvcmVSYW5nZSgpO1xuICAgIGlmIChtaW5TY29yZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwcm90b0J1ZlNjb3JlUmFuZ2UubWluX2luY2x1c2l2ZSA9IG1pblNjb3JlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm90b0J1ZlNjb3JlUmFuZ2UudW5ib3VuZGVkX21pbiA9IG5ldyBsZWFkZXJib2FyZC5fVW5ib3VuZGVkKCk7XG4gICAgfVxuICAgIGlmIChtYXhTY29yZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwcm90b0J1ZlNjb3JlUmFuZ2UubWF4X2V4Y2x1c2l2ZSA9IG1heFNjb3JlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm90b0J1ZlNjb3JlUmFuZ2UudW5ib3VuZGVkX21heCA9IG5ldyBsZWFkZXJib2FyZC5fVW5ib3VuZGVkKCk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBsZWFkZXJib2FyZC5fR2V0QnlTY29yZVJlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgbGVhZGVyYm9hcmQ6IGxlYWRlcmJvYXJkTmFtZSxcbiAgICAgIHNjb3JlX3JhbmdlOiBwcm90b0J1ZlNjb3JlUmFuZ2UsXG4gICAgICBvcmRlcjogcHJvdG9CdWZPcmRlcixcbiAgICAgIG9mZnNldDogb2Zmc2V0LFxuICAgICAgbGltaXRfZWxlbWVudHM6IGNvdW50LFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShjYWNoZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldE5leHREYXRhQ2xpZW50KCkuR2V0QnlTY29yZShcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwOiB1bmtub3duKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIGNvbnN0IGZvdW5kRWxlbWVudHMgPSAocmVzcCBhcyBsZWFkZXJib2FyZC5fR2V0QnlTY29yZVJlc3BvbnNlKVxuICAgICAgICAgICAgICAuZWxlbWVudHM7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMZWFkZXJib2FyZEZldGNoLlN1Y2Nlc3MoZm91bmRFbGVtZW50cykpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IExlYWRlcmJvYXJkRmV0Y2guRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBmZXRjaEJ5UmFuayhcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBzdGFydFJhbms6IG51bWJlcixcbiAgICBlbmRSYW5rOiBudW1iZXIsXG4gICAgb3JkZXI/OiBMZWFkZXJib2FyZE9yZGVyXG4gICk6IFByb21pc2U8TGVhZGVyYm9hcmRGZXRjaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJhbmtPcmRlciA9IG9yZGVyID8/IExlYWRlcmJvYXJkT3JkZXIuQXNjZW5kaW5nO1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUxlYWRlcmJvYXJkUmFua3Moc3RhcnRSYW5rLCBlbmRSYW5rKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IExlYWRlcmJvYXJkRmV0Y2guRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICBgSXNzdWluZyAnZmV0Y2hCeVJhbmsnIHJlcXVlc3Q7IGNhY2hlOiAke2NhY2hlTmFtZX0sIGxlYWRlcmJvYXJkOiAke2xlYWRlcmJvYXJkTmFtZX0sIG9yZGVyOiAke3JhbmtPcmRlci50b1N0cmluZygpfSwgc3RhcnRSYW5rOiAke3N0YXJ0UmFua30sIGVuZFJhbms6ICR7ZW5kUmFua31gXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kRmV0Y2hCeVJhbmsoXG4gICAgICBjYWNoZU5hbWUsXG4gICAgICBsZWFkZXJib2FyZE5hbWUsXG4gICAgICBzdGFydFJhbmssXG4gICAgICBlbmRSYW5rLFxuICAgICAgcmFua09yZGVyXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZEZldGNoQnlSYW5rKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIHN0YXJ0UmFuazogbnVtYmVyLFxuICAgIGVuZFJhbms6IG51bWJlcixcbiAgICBvcmRlcjogTGVhZGVyYm9hcmRPcmRlclxuICApOiBQcm9taXNlPExlYWRlcmJvYXJkRmV0Y2guUmVzcG9uc2U+IHtcbiAgICBjb25zdCBwcm90b0J1Zk9yZGVyID1cbiAgICAgIG9yZGVyID09PSBMZWFkZXJib2FyZE9yZGVyLkRlc2NlbmRpbmdcbiAgICAgICAgPyBsZWFkZXJib2FyZC5fT3JkZXIuREVTQ0VORElOR1xuICAgICAgICA6IGxlYWRlcmJvYXJkLl9PcmRlci5BU0NFTkRJTkc7XG5cbiAgICBjb25zdCBwcm90b0J1ZlJhbmtSYW5nZSA9IG5ldyBsZWFkZXJib2FyZC5fUmFua1JhbmdlKHtcbiAgICAgIHN0YXJ0X2luY2x1c2l2ZTogc3RhcnRSYW5rLFxuICAgICAgZW5kX2V4Y2x1c2l2ZTogZW5kUmFuayxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgbGVhZGVyYm9hcmQuX0dldEJ5UmFua1JlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgbGVhZGVyYm9hcmQ6IGxlYWRlcmJvYXJkTmFtZSxcbiAgICAgIHJhbmtfcmFuZ2U6IHByb3RvQnVmUmFua1JhbmdlLFxuICAgICAgb3JkZXI6IHByb3RvQnVmT3JkZXIsXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKGNhY2hlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKS5HZXRCeVJhbmsoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVycjogU2VydmljZUVycm9yIHwgbnVsbCwgcmVzcDogdW5rbm93bikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICBjb25zdCBmb3VuZEVsZW1lbnRzID0gKHJlc3AgYXMgbGVhZGVyYm9hcmQuX0dldEJ5UmFua1Jlc3BvbnNlKVxuICAgICAgICAgICAgICAuZWxlbWVudHM7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMZWFkZXJib2FyZEZldGNoLlN1Y2Nlc3MoZm91bmRFbGVtZW50cykpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IExlYWRlcmJvYXJkRmV0Y2guRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRSYW5rKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nLFxuICAgIGlkczogQXJyYXk8bnVtYmVyPixcbiAgICBvcmRlcj86IExlYWRlcmJvYXJkT3JkZXJcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZEZldGNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3Qgb3JkZXJWYWx1ZSA9IG9yZGVyID8/IExlYWRlcmJvYXJkT3JkZXIuQXNjZW5kaW5nO1xuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ2dldFJhbmsnIHJlcXVlc3Q7IGNhY2hlOiAke2NhY2hlTmFtZX0sIGxlYWRlcmJvYXJkOiAke2xlYWRlcmJvYXJkTmFtZX0sIG9yZGVyOiAke29yZGVyVmFsdWUudG9TdHJpbmcoKX0sIG51bWJlciBvZiBpZHM6ICR7XG4gICAgICAgIGlkcy5sZW5ndGhcbiAgICAgIH1gXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kR2V0UmFuayhjYWNoZU5hbWUsIGxlYWRlcmJvYXJkTmFtZSwgaWRzLCBvcmRlclZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZEdldFJhbmsoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmcsXG4gICAgaWRzOiBBcnJheTxudW1iZXI+LFxuICAgIG9yZGVyOiBMZWFkZXJib2FyZE9yZGVyXG4gICk6IFByb21pc2U8TGVhZGVyYm9hcmRGZXRjaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHByb3RvQnVmT3JkZXIgPVxuICAgICAgb3JkZXIgPT09IExlYWRlcmJvYXJkT3JkZXIuRGVzY2VuZGluZ1xuICAgICAgICA/IGxlYWRlcmJvYXJkLl9PcmRlci5ERVNDRU5ESU5HXG4gICAgICAgIDogbGVhZGVyYm9hcmQuX09yZGVyLkFTQ0VORElORztcblxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgbGVhZGVyYm9hcmQuX0dldFJhbmtSZXF1ZXN0KHtcbiAgICAgIGNhY2hlX25hbWU6IGNhY2hlTmFtZSxcbiAgICAgIGxlYWRlcmJvYXJkOiBsZWFkZXJib2FyZE5hbWUsXG4gICAgICBpZHM6IGlkcyxcbiAgICAgIG9yZGVyOiBwcm90b0J1Zk9yZGVyLFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShjYWNoZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldE5leHREYXRhQ2xpZW50KCkuR2V0UmFuayhcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwOiB1bmtub3duKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIGNvbnN0IGZvdW5kRWxlbWVudHMgPSAocmVzcCBhcyBsZWFkZXJib2FyZC5fR2V0UmFua1Jlc3BvbnNlKVxuICAgICAgICAgICAgICAuZWxlbWVudHM7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMZWFkZXJib2FyZEZldGNoLlN1Y2Nlc3MoZm91bmRFbGVtZW50cykpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IExlYWRlcmJvYXJkRmV0Y2guRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsZW5ndGgoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZExlbmd0aC5SZXNwb25zZT4ge1xuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ2xlbmd0aCcgcmVxdWVzdDsgY2FjaGU6ICR7Y2FjaGVOYW1lfSwgbGVhZGVyYm9hcmQ6ICR7bGVhZGVyYm9hcmROYW1lfWBcbiAgICApO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRMZW5ndGgoY2FjaGVOYW1lLCBsZWFkZXJib2FyZE5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kTGVuZ3RoKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIGxlYWRlcmJvYXJkTmFtZTogc3RyaW5nXG4gICk6IFByb21pc2U8TGVhZGVyYm9hcmRMZW5ndGguUmVzcG9uc2U+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGxlYWRlcmJvYXJkLl9HZXRMZWFkZXJib2FyZExlbmd0aFJlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgbGVhZGVyYm9hcmQ6IGxlYWRlcmJvYXJkTmFtZSxcbiAgICB9KTtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuY3JlYXRlTWV0YWRhdGEoY2FjaGVOYW1lKTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5nZXROZXh0RGF0YUNsaWVudCgpLkdldExlYWRlcmJvYXJkTGVuZ3RoKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAge1xuICAgICAgICAgIGludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnMsXG4gICAgICAgIH0sXG4gICAgICAgIChlcnI6IFNlcnZpY2VFcnJvciB8IG51bGwsIHJlc3A6IHVua25vd24pID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gKHJlc3AgYXMgbGVhZGVyYm9hcmQuX0dldExlYWRlcmJvYXJkTGVuZ3RoUmVzcG9uc2UpXG4gICAgICAgICAgICAgIC5jb3VudDtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExlYWRlcmJvYXJkTGVuZ3RoLlN1Y2Nlc3MobGVuZ3RoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGVhZGVyYm9hcmRMZW5ndGguRXJyb3IoZSksXG4gICAgICAgICAgICAgIHJlc29sdmVGbjogcmVzb2x2ZSxcbiAgICAgICAgICAgICAgcmVqZWN0Rm46IHJlamVjdCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZW1vdmVFbGVtZW50cyhcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBpZHM6IEFycmF5PG51bWJlcj5cbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZFJlbW92ZUVsZW1lbnRzLlJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlTGVhZGVyYm9hcmROdW1iZXJPZkVsZW1lbnRzKGlkcy5sZW5ndGgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgIGVyciA9PiBuZXcgTGVhZGVyYm9hcmRSZW1vdmVFbGVtZW50cy5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdyZW1vdmVFbGVtZW50cycgcmVxdWVzdDsgY2FjaGU6ICR7Y2FjaGVOYW1lfSwgbGVhZGVyYm9hcmQ6ICR7bGVhZGVyYm9hcmROYW1lfSwgbnVtYmVyIG9mIGVsZW1lbnRzOiAke2lkcy5sZW5ndGgudG9TdHJpbmcoKX1gXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kUmVtb3ZlRWxlbWVudHMoY2FjaGVOYW1lLCBsZWFkZXJib2FyZE5hbWUsIGlkcyk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRSZW1vdmVFbGVtZW50cyhcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZyxcbiAgICBpZHM6IEFycmF5PG51bWJlcj5cbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZFJlbW92ZUVsZW1lbnRzLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBsZWFkZXJib2FyZC5fUmVtb3ZlRWxlbWVudHNSZXF1ZXN0KHtcbiAgICAgIGNhY2hlX25hbWU6IGNhY2hlTmFtZSxcbiAgICAgIGxlYWRlcmJvYXJkOiBsZWFkZXJib2FyZE5hbWUsXG4gICAgICBpZHM6IGlkcyxcbiAgICB9KTtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuY3JlYXRlTWV0YWRhdGEoY2FjaGVOYW1lKTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5nZXROZXh0RGF0YUNsaWVudCgpLlJlbW92ZUVsZW1lbnRzKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAge1xuICAgICAgICAgIGludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnMsXG4gICAgICAgIH0sXG4gICAgICAgIChlcnI6IFNlcnZpY2VFcnJvciB8IG51bGwsIHJlc3A6IHVua25vd24pID0+IHtcbiAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgTGVhZGVyYm9hcmRSZW1vdmVFbGVtZW50cy5TdWNjZXNzKCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT5cbiAgICAgICAgICAgICAgICBuZXcgTGVhZGVyYm9hcmRSZW1vdmVFbGVtZW50cy5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZShcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICBsZWFkZXJib2FyZE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPExlYWRlcmJvYXJkRGVsZXRlLlJlc3BvbnNlPiB7XG4gICAgdGhpcy5sb2dnZXIudHJhY2UoXG4gICAgICBgSXNzdWluZyAnZGVsZXRlJyByZXF1ZXN0OyBjYWNoZTogJHtjYWNoZU5hbWV9LCBsZWFkZXJib2FyZDogJHtsZWFkZXJib2FyZE5hbWV9YFxuICAgICk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZERlbGV0ZShjYWNoZU5hbWUsIGxlYWRlcmJvYXJkTmFtZSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmREZWxldGUoXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgbGVhZGVyYm9hcmROYW1lOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxMZWFkZXJib2FyZERlbGV0ZS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgbGVhZGVyYm9hcmQuX0RlbGV0ZUxlYWRlcmJvYXJkUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgICBsZWFkZXJib2FyZDogbGVhZGVyYm9hcmROYW1lLFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShjYWNoZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldE5leHREYXRhQ2xpZW50KCkuRGVsZXRlTGVhZGVyYm9hcmQoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVycjogU2VydmljZUVycm9yIHwgbnVsbCwgcmVzcDogdW5rbm93bikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMZWFkZXJib2FyZERlbGV0ZS5TdWNjZXNzKCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJlc29sdmVPclJlamVjdEVycm9yKHtcbiAgICAgICAgICAgICAgZXJyOiBlcnIsXG4gICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IExlYWRlcmJvYXJkRGVsZXRlLkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0TmV4dERhdGFDbGllbnQoKTogbGVhZGVyYm9hcmQuTGVhZGVyYm9hcmRDbGllbnQge1xuICAgIGNvbnN0IGNsaWVudFdyYXBwZXIgPSB0aGlzLmNsaWVudFdyYXBwZXJzW3RoaXMubmV4dERhdGFDbGllbnRJbmRleF07XG4gICAgdGhpcy5uZXh0RGF0YUNsaWVudEluZGV4ID1cbiAgICAgICh0aGlzLm5leHREYXRhQ2xpZW50SW5kZXggKyAxKSAlIHRoaXMuY2xpZW50V3JhcHBlcnMubGVuZ3RoO1xuICAgIHJldHVybiBjbGllbnRXcmFwcGVyLmdldENsaWVudCgpO1xuICB9XG59XG4iXX0=